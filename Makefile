export PATH := $(PATH):/usr/local/go/bin

OUT_BIN = ninit
DOCKER_IMAGE = golang:1.16.1-alpine

CP_BIN ?= cp
DOCKER_BIN ?= docker
ENV_BIN ?= env
FIND_BIN ?= find
GO_BIN ?= go
LINT_BIN ?= golangci-lint
MKDIR_BIN ?= mkdir
PRINTF_BIN ?= printf

VERSION_PATH = pkg/version/.autogenerated
BUILD_VERSION ?= $(shell git describe --always --dirty --broken --abbrev=8)
BUILT_TIME ?= $(shell date +%Y-%m-%dT%H:%M:%S%z)

all: clean lint build

.PHONY: pre
pre:
	$(MKDIR_BIN) -p bin $(VERSION_PATH)
	$(CP_BIN) -a hack/Dockerfile bin/Dockerfile
	$(PRINTF_BIN) "$(BUILD_VERSION)" > $(VERSION_PATH)/version
	$(PRINTF_BIN) "$(BUILT_TIME)" > $(VERSION_PATH)/buildTime

.PHONY: tidy
tidy:
	$(GO_BIN) mod tidy

.PHONY: build
build: pre tidy
	# https://golang.org/cmd/link/
	$(ENV_BIN) CGO_ENABLED=0 GOOS=linux $(GO_BIN) build -ldflags '-s -w -extldflags "-static"' -o bin/$(OUT_BIN) -v

.PHONY: docker
docker: pre tidy
	$(DOCKER_BIN) pull $(DOCKER_IMAGE)
	$(DOCKER_BIN) rm --force build || true
	$(DOCKER_BIN) run --detach --tty --rm --network host --name build --hostname build \
	  --mount type=bind,source="$(CURDIR)/",target=/build $(DOCKER_IMAGE)
	$(DOCKER_BIN) exec build sh -c "apk update && apk add gcc musl-dev"
	$(DOCKER_BIN) exec --workdir=/build build go build -race -o bin/$(OUT_BIN) -v
	$(DOCKER_BIN) exec --workdir=/build build cc -static hack/zombie.c -o bin/zombie
	$(DOCKER_BIN) stop build

.PHONY: update
update: pre tidy
	$(ENV_BIN) GOPROXY=direct GOPRIVATE=github.com/s3rj1k/* $(GO_BIN) get -u
	$(GO_BIN) get -u github.com/golangci/golangci-lint/cmd/golangci-lint@v1.38.0

.PHONY: clean
clean:
	$(GO_BIN) clean
	$(FIND_BIN) bin -type f -delete || true
	$(FIND_BIN) $(VERSION_PATH)/ -type f -delete || true
	$(FIND_BIN) . -type d -empty -delete

.PHONY: test
test: pre tidy
	$(GO_BIN) test -failfast ./...

.PHONY: lint
lint: pre tidy
	$(LINT_BIN) run ./...
